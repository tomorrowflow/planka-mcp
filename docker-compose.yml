networks:
  planka-network:
    external: true

services:
  # Planka MCP HTTP Server - connects to Planka via shared Docker network
  planka-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: planka-mcp:latest
    container_name: planka-mcp
    restart: unless-stopped
    networks:
      - planka-network
    ports:
      - "${MCP_KANBAN_PORT:-3008}:3008"
    environment:
      # Planka connection settings
      - PLANKA_BASE_URL=${PLANKA_BASE_URL}
      - PLANKA_AGENT_EMAIL=${PLANKA_AGENT_EMAIL}
      - PLANKA_AGENT_PASSWORD=${PLANKA_AGENT_PASSWORD}
      # Server settings
      - PLANKA_MCP_PORT=3008
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - planka-mcp-attachments:/app/attachments
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Local Planka instance (uncomment if you want to run Planka locally)
  # planka:
  #   image: ghcr.io/plankanban/planka:latest
  #   container_name: planka
  #   restart: unless-stopped
  #   ports:
  #     - "${PLANKA_PORT:-3333}:1337"
  #   environment:
  #     - BASE_URL=${BASE_URL}
  #     - TRUST_PROXY=${TRUST_PROXY}
  #     - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable
  #     - SECRET_KEY=${SECRET_KEY}
  #     - DEFAULT_ADMIN_EMAIL=${PLANKA_ADMIN_EMAIL}
  #     - DEFAULT_ADMIN_PASSWORD=${PLANKA_ADMIN_PASSWORD}
  #     - DEFAULT_ADMIN_NAME=${PLANKA_ADMIN_NAME}
  #     - DEFAULT_ADMIN_USERNAME=${PLANKA_ADMIN_USERNAME}
  #     - NODE_ENV=production
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   volumes:
  #     - planka-files:/app/public/user-files
  #     - planka-user-avatars:/app/public/user-avatars
  #     - planka-project-background-images:/app/public/project-background-images
  #     - planka-attachments:/app/private/attachments

  # Optional: PostgreSQL for local Planka (uncomment if you want to run Planka locally)
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: planka-postgres
  #   restart: unless-stopped
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #     - POSTGRES_DB=${POSTGRES_DB}
  #     - POSTGRES_HOST_AUTH_METHOD=trust
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   volumes:
  #     - planka-db:/var/lib/postgresql/data
  #   command:
  #     - "postgres"
  #     - "-c"
  #     - "max_connections=100"
  #     - "-c"
  #     - "shared_buffers=256MB"

volumes:
  planka-mcp-attachments:
    name: planka-mcp-attachments
  # Uncomment if running local Planka
  # planka-db:
  #   name: planka-db-persistent
  # planka-files:
  # planka-user-avatars:
  # planka-project-background-images:
  # planka-attachments:
